<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
    xmlns:ext="http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:wicket="http://www.ops4j.org/schema/wicket"
    xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0
        http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0 http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0
        http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.0.0 http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.0.0
        http://karaf.apache.org/xmlns/shell/v1.0.0 http://karaf.apache.org/xmlns/shell/v1.0.0">

	<bean class="org.soluvas.commons.EPackageRegistration" init-method="init" destroy-method="destroy">
		<argument ref="blueprintBundleContext" />
		<argument>
			<list value-type="java.lang.Class">
				<value>org.soluvas.web.site.SitePackage</value>
				<value>org.soluvas.web.site.pagemeta.PageMetaPackage</value>
				<value>org.soluvas.web.site.webaddress.WebaddressPackage</value>
				<value>org.soluvas.web.site.compose.ComposePackage</value>
			</list>
		</argument>
	</bean>
	
	<bean id="placeholderRepository" class="org.soluvas.web.site.compose.EmfGenericRepository" />
	<bean id="slaveRepository" class="org.soluvas.web.site.compose.EmfGenericRepository" />
	<bean id="contributorRepository" class="org.soluvas.web.site.compose.EmfGenericRepository" />
	<service ref="contributorRepository" auto-export="interfaces">
		<service-properties>
			<entry key="suppliedClass" value="org.soluvas.web.compose.LiveContributor" />
		</service-properties>
	</service>
	
	<bean id="composeCatalogXmiTracker" class="org.soluvas.web.site.compose.ComposeCatalogXmiTracker">
		<argument ref="placeholderRepository" />
		<argument ref="slaveRepository" />
		<argument ref="contributorRepository" />
	</bean>
	<bean class="org.osgi.util.tracker.BundleTracker" init-method="open" destroy-method="close">
		<argument ref="blueprintBundleContext" />
		<argument value="32" />
		<argument ref="composeCatalogXmiTracker" />
	</bean>

	<!-- TODO: For multitenant installations, replace with ManagedServiceFactory, when Aries Blueprint fixed its ARIES-584 bug -->
<!-- 	<cm:managed-service-factory factory-pid="org.soluvas.web.site" auto-export="interfaces"> -->
<!-- 		<description>Soluvas Web Site instance</description> -->
<!-- 		<cm:managed-component class="org.soluvas.web.site.SimpleSite"/> -->
<!-- 	</cm:managed-service-factory> -->

    <cm:property-placeholder persistent-id="org.soluvas.web.site" update-strategy="reload">
        <cm:default-properties>
            <cm:property name="siteTitle"			value="FashionWow"/>
            <cm:property name="homeTitle"			value="Cute and trendy clothing, dresses, and skirts"/>
            <cm:property name="pageTitleSuffix"		value="| FashionWow"/>
            <cm:property name="logoText"			value="FashionWow"/>
            <cm:property name="logoAlt"				value="Cute and trendy clothing, dresses, and skirts"/>
            <cm:property name="footerHtml"			value="Copyright Â© 2012 Soluvas"/>
        </cm:default-properties>
    </cm:property-placeholder>
    
	<service auto-export="interfaces">
		<bean class="org.ops4j.pax.web.extender.whiteboard.runtime.DefaultResourceMapping">
			<property name="alias" value="/static/org.soluvas.web.site/images"/>
			<property name="path" value="/img"/>
		</bean>
	</service>

	<!-- Site is DEPRECATED -->
	<service auto-export="interfaces" ranking="-100">
		<service-properties>
			<entry key="clientId" value="*"/>
			<entry key="tenantId" value="*"/>
			<entry key="tenantEnv" value="*"/>
			<entry key="layer" value="application"/>
		</service-properties>
		<bean class="org.soluvas.web.site.SimpleSite">
			<property name="siteTitle"			value="${siteTitle}"/>
			<property name="homeTitle"			value="${homeTitle}"/>
			<property name="pageTitleSuffix"	value="${pageTitleSuffix}"/>
			<property name="logoText"			value="${logoText}"/>		
			<property name="logoAlt"			value="${logoAlt}"/>
			<property name="footerHtml"			value="${footerHtml}"/>		
			<property name="faviconUri"			value="/static/org.soluvas.web.site/images/soluvas-favicon.ico"/>
		</bean>
	</service>
	
	<reference-list id="jsModules" interface="org.soluvas.web.site.JavaScriptModule"
		availability="optional" member-type="service-reference" />
	<reference-list id="jsShims" interface="org.soluvas.web.site.JavaScriptShim" availability="optional" />
	
	<reference id="siteCatalogSupplier" interface="com.google.common.base.Supplier" availability="optional"
		filter="(suppliedClass=org.soluvas.web.site.SiteCatalog)" />
	
	<command-bundle xmlns="http://karaf.apache.org/xmlns/shell/v1.1.0">
		<!-- JavaScript -->
		<command name="js/ls">
			<action class="org.soluvas.web.site.shell.JsLsCommand">
				<argument ref="blueprintBundleContext" />
				<argument ref="jsModules" />
			</action>
		</command>
		<command name="js/lsshim">
			<action class="org.soluvas.web.site.shell.JsLsShimCommand">
				<argument ref="jsShims" />
			</action>
		</command>
		<!-- Site -->
		<command name="site/pagels">
			<action class="org.soluvas.web.site.shell.SitePageLsCommand">
				<argument ref="siteCatalogSupplier" />
			</action>
		</command>
		<!-- Compose -->
		<command name="compose/placels">
			<action class="org.soluvas.web.site.shell.ComposePlaceLsCommand">
				<argument ref="placeholderRepository" />
			</action>
		</command>
		<command name="compose/slavels">
			<action class="org.soluvas.web.site.shell.ComposeSlaveLsCommand">
				<argument ref="slaveRepository" />
			</action>
		</command>
		<command name="compose/contribls">
			<action class="org.soluvas.web.site.shell.ComposeContribLsCommand">
				<argument ref="contributorRepository" />
			</action>
		</command>
	</command-bundle>
	
	<bean id="siteRs" class="org.soluvas.web.site.rs.SiteResource">
		<argument ref="blueprintBundleContext" />
	</bean>
	<service auto-export="interfaces">
		<service-properties>
			<entry key="clientId" value="*"/>
			<entry key="tenantId" value="*"/>
			<entry key="tenantEnv" value="*"/>
			<entry key="type" value="jaxrs"/>
			<entry key="address" value="api"/>
		</service-properties>
		<bean class="java.util.ArrayList">
			<argument>
				<list>
					<ref component-id="siteRs" />
				</list>
			</argument>
		</bean>
	</service>
	<service auto-export="interfaces">
		<bean class="org.soluvas.web.site.JavaScriptModuleImpl">
			<argument value="org.soluvas.web.site/webAddress" />
			<argument value="org.soluvas.web.site/webAddress" />
			<argument value="org.soluvas.web.site/webAddress" />
			<argument value="DYNAMIC" />
		</bean>
	</service>

</blueprint>
